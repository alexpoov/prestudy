---
title: "Prestudy Report"
author: "sasha popov"
date: "`r Sys.Date()`"
output:
  rmdformats::html_clean:
    keep_md: true
    self_contained: true
    thumbnails: false
    lightbox: true
    gallery: false
    highlight: tango
    code_folding: hide
    toc: TRUE
    toc_depth: 3
    fig_width: 12
    fig_height: 8

---

## 1. Demographic Data (Exploratry Data Analysis, a.k.a. Overview)

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(gt)
source("analysfunc.R")
df_act = compose_df("user") |> 
  mutate(timestamp = ymd_hms(timestamp))
resp = elicit_respondents(df_act, no_timestamp = FALSE) |> 
  left_join(institute_lookup, by = c("subj" = "dep")) |> 
  na.omit()
```

Overall participants:

```{r}
print(nrow(resp))
```


Our respondent's data has 6 key observations:  

* `age` - age. 
* `gender` (with ability to enter gender if non-binary). 
* `subj` - department of the student's program/major. 
* `edu_year` - amount of years in the university. 
* `occup` - amount of years in Norway. 
* `family_acad` - highest degree of parents. 
* `orient`- sexual orientation. 

```{r}
resp |> head() 
```

Let's plot demographic data

### Age & Gender

```{r}
resp |> 
  group_by(gender) |> 
  count()
```

We see that gender is evenly distributed over the survey.

```{r}
data_age_gender = resp |> 
    mutate(age = as.numeric(age)) |>
    count(age, gender) |>
    complete(age = 18:40, fill = list(n = 0))

ggplot(data_age_gender) +
  geom_bar(aes(x = age, y = n, fill = gender), stat = "identity") +
  theme_minimal() +
  labs(
    title = "Age/Gender Distribution of Prestudy Respondents",
    subtitle = "absolute values",
    x = "Age",
    y = "Respondents"
  ) +
  scale_fill_manual(values=c("#DD6C40", "#509DA9", "#C4E059"))
```

```{r}
ggplot(data_age_gender |> group_by(age) |> mutate(total_resp = sum(n)) |> filter(total_resp >= 10))+
  geom_bar(aes(x = age, y = n, fill = gender), stat = "identity", position = "fill") +
  theme_minimal() +
  labs(
    title = "Age/Gender Distribution of Prestudy Respondents",
    subtitle = "relative values for years with 10+ obs",
    x = "Age",
    y = "Respondents"
  ) +
  scale_fill_manual(values=c("#DD6C40", "#509DA9", "#C4E059"))
```

Maybe it's make sense to replace gender "other" to non-binary in plots:

```{r}
resp |> 
  filter(gender == "other") |> 
  select(gender_oth) |> 
  head()
```

### Departments & Institutes

We still have majority of students from ex-MATNAT, and 0 respondents from Medicine and Law Faculties:



```{r}
data_inst_dep = resp |> 
  group_by(institute, subj) |> 
  count() |> 
  full_join(institute_lookup, by = c("institute", "subj" = "dep")) |> 
  mutate(n = ifelse(is.na(n), 0, n))

cutiepie = c("Faculty of Fine Art, Music and Design" = "#9A3FE5", "Faculty of Humanities" = "#D5CC4A", "Faculty of Law" = "#B73737", "Faculty of Mathematics and Natural Sciences" = "#2C968C", "Faculty of Medicine" = "#55DB46", "Faculty of Psychology" = "#3E63B3", "Faculty of Social Sciences" = "#C48E43")


institue_color = data_inst_dep |>
  group_by(institute) |> 
  count() |> 
  cbind(color = cutiepie) |>  # 7 institutes 7 colors
  select(-n)

dep_color_palette_vector = generate_department_colors(data_inst_dep, institue_color) 
dep_color_palette = data.frame(Name = names(dep_color_palette_vector), Value = dep_color_palette_vector, stringsAsFactors = FALSE, row.names = NULL)
data_inst_dep = data_inst_dep |> 
  left_join(dep_color_palette, by = c("subj" = "Name")) |> 
  mutate(institute_subj = interaction(institute, subj, sep = ": ")) |> 
  arrange(institute_subj)
```

```{r}
data_inst_dep  |> 
  ggplot() +
  geom_bar(aes(x = institute, y = n), stat = "identity") +
  theme_minimal() + 
  labs(
    title = "Respondents by Institute",
    fill = "Department",
    x = "institute",
    y = "respondents"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

```{r}
data_inst_dep_nonull = data_inst_dep  |> 
  filter(n>0)
data_inst_dep_nonull |> 
  ggplot() +
  geom_bar(aes(x = institute, y = n, fill = institute_subj), stat = "identity") +
  theme_minimal() + 
  labs(
    title = "Respondents by Department",
    fill = "Department",
    x = "institute",
    y = "respondents"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1)) + 
  scale_fill_manual(values = data_inst_dep_nonull$Value) + 
  guides(fill = guide_legend(ncol = 1))
```

### Education Year

```{r}
data_edu_years = resp |> 
  mutate(edu_year = as.numeric(edu_year)) |> 
  group_by(gender, edu_year) |> 
  count(edu_year) |> 
  filter(edu_year < 10)

ggplot(data_edu_years) +
  geom_bar(aes(x = edu_year, y = n, fill = gender), stat = "identity") +
  theme_minimal() +
  labs(
    title = "Current Year as a Student",
    subtitle = "Distribution of Prestudy Respondents",
    x = "Years of Education",
    y = "Respondents"
  ) +
  scale_fill_manual(values=c("#DD6C40", "#509DA9", "#C4E059"))
```

### Occupation

This was a proxy on native / international student:

```{r}
cat(sum(resp$age == resp$occup), " ot of ", nrow(resp), " respondents lived in Norway the whole life (", round(sum(resp$age == resp$occup)/nrow(resp)*100,2), "%)", sep = "")
```

Only a small part of students are from abroad: 

```{r}
resp_no_full_norw = resp |> 
  filter(age != occup) |> 
  select(age, occup) |> 
  mutate(
    age = as.numeric(age),
    occup = as.numeric(occup),
    diff = age - occup) |> 
  filter(diff > 0) 

resp_no_full_norw |> 
  summarise(average_age_occup_differnece = mean(diff))
```

```{r}
ggplot(resp_no_full_norw) + 
  geom_bar(aes(x = occup)) + 
  theme_minimal() + 
  labs(
    title = "Years in Norway",
    subtitle = "Distribution for students whos age != occup_years",
    x = "Years in Norway",
    y = "Respondents"
  )
```

### First of the Family

Higher degree of family members can also correlate with the preformance, well-being, etc. 

```{r}
data_family =  resp |> 
  group_by(family_acad, institute) |> 
  count() |> 
  mutate(family_acad = factor(family_acad,
                                 levels = c(
                                   "elementary school",
                                   "secondary school" ,
                                   "Bachelor (or equivalent)",
                                   "Master (or equivalent)",
                                   "PhD")),
         institute = factor(institute, 
                            levels = c("Faculty of Fine Art, Music and Design ", "Faculty of Humanities", "Faculty of Mathematics and Natural Sciences", "Faculty of Psychology", "Faculty of Social Sciences"))) |> 
  left_join(institue_color, by = "institute")

ggplot(data_family) +
  geom_bar(aes(x = family_acad, y = n), stat = "identity") + 
  theme_minimal() + 
  labs(
    title = "Parents' highest degree",
    x = "Highest Degree",
    y = "Respondents"
  ) 
```

```{r}
data_family  |> 
  arrange(institute) |> 
  ggplot() +
    geom_bar(aes(x = family_acad, y = n, fill = institute), stat = "identity") + 
    theme_minimal() + 
    labs(
      title = "Parents' highest degree",
      x = "Highest Degree",
      y = "Respondents", 
      fill = "Faculty"
    ) +
  scale_fill_manual(values = c(cutiepie[-3][-4], "black", "black", "black", "black"))


```

### Sexual Orientation

```{r}
data_so = resp |> 
  filter(orient != "") |> 
  group_by(orient) |> 
  count()

ggplot(data_so) +
  geom_bar(aes(x = orient, y = n), stat = "identity") + 
  theme_minimal() + 
  labs(
    title = "Sexual Orientation",
    x = "Highest Degree",
    y = "Orientation"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

## 2. Responses Analysis

```{r}
# todo: filtering by amount of responses

topics_df = topics_df = read.csv('~/PhD/proj/code/pre-study/prestudy_app/prestudy_topics.csv')

scale_genderness = c("Completely Masculine", "Mostly Masculine", "Slightly Masculine", "Neutral", "Slightly Feminine", "Mostly Feminine", "Completely Feminine")
scale_familiarity = c("Not Familiar at All", "Slightly Familiar", "Moderately Familiar", "Very Familiar", "Highly Familiar")

evals = compose_df("evals") |> 
  mutate(familiarity = factor(familiarity, levels = scale_familiarity),
         gender = factor(gender, levels = scale_genderness)) 

topics_long <- topics_df %>%
  pivot_longer(cols = c(cs, econ, lang), 
               names_to = "field", 
               values_to = "topic") %>%
  select(topic_subcategory, topic, field)

evals <- evals %>%
  left_join(topics_long, by = c("topic" = "topic")) |> 
  mutate(topic = ifelse(is.na(topic_subcategory), topic, topic_subcategory),,
         field = ifelse(is.na(field), "base", field)) %>% 
  select(-topic_subcategory) 

head(evals)
```

* For gender perception evaluations, as expected, totally normal distribution:

```{r}
evals |> 
  group_by(gender_level = as.factor(gender)) |> 
  count() |> 
  ggplot() +
  geom_bar(aes(x = gender_level, y = n), stat = "identity") +
  theme_minimal() +
  labs(title = "Distribution of gender evaluations in the prestudy",
       x = "Level of gender perception",
       y = "Observations") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

* For familiarity evaluations, in contrast, there's a more versatile distribution:

```{r}
evals |> 
  group_by(fam_level = as.factor(familiarity)) |> 
  count() |> 
  ggplot() +
  geom_bar(aes(x = fam_level, y = n), stat = "identity") +
  theme_minimal() +
  labs(title = "Distribution of familiarity evaluations in the prestudy",
       x = "Level of familiarity",
       y = "Observations") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

```{r}
evals2 = evals |> 
  mutate(gender = as.numeric(gender) - 4,
         familiarity = as.numeric(familiarity)) 
```

### Known Issues

#### Randomisation

Due to incorrect placement of `generate_topics()` function within the server, topics were generated in the same sample/order for all students of the current run, and changed only when the server was restarted.

```{r}
total_df = resp |> 
  rename(sex = gender) |> 
  mutate(sex = fct_recode(sex, "non binary"="other")) |> 
  left_join(evals2, by="id") |> 
  na.omit()
```

```{r}
  # 
ii = total_df |> 
  filter(subj == 'Department of Informatics') |> 
  group_by(topic, round) |> 
  count() |> 
    pivot_wider(
    names_from = round, 
    values_from = n,
    names_prefix = "ii_round"
  )

matnat = total_df |> 
  filter(institute == 'Faculty of Mathematics and Natural Sciences' & subj != 'Department of Informatics') |> 
  group_by(topic, round) |> 
  count() |> 
    pivot_wider(
    names_from = round, 
    values_from = n,
    names_prefix = "matnat_no_ii"
  )

other_inst = total_df |> 
  filter(institute != 'Faculty of Mathematics and Natural Sciences') |> 
  group_by(topic, round) |> 
  count() |> 
    pivot_wider(
    names_from = round, 
    values_from = n,
    names_prefix = "oth_inst"
  )

occurences = topics_df |> 
  select(topic_subcategory) |> 
  left_join(ii, by = c('topic_subcategory' = 'topic')) |> 
  left_join(matnat, by = c('topic_subcategory' = 'topic')) |> 
  left_join(other_inst, by = c('topic_subcategory' = 'topic')) |> 
  mutate(across(everything(), replace_na, 0)) |> 
  group_by(topic_subcategory) |> 
  mutate(total = sum(ii_round1, ii_round2, matnat_no_ii1, matnat_no_ii2, oth_inst1, oth_inst2)) |> 
  arrange(-total) |> 
  ungroup() 
  
occurences |> 
  gt() |> 
  data_color(
  columns = vars(ii_round1, ii_round2, matnat_no_ii1, matnat_no_ii2, oth_inst1, oth_inst2),
  colors = scales::col_numeric(
    c("lightgrey", "green"), 
    domain = c(0, 100)))
```

* we need to test hypothesis on the role of the context on topics that have enough observetions both in rounds 1 and 2.
  * if there's an effect, that's good
  * if there's NO effect, we can combine both rounds and get more observations. 
  
There are 17/55 topics with 20+ observations for each of the groups of interest:
  
```{r}
occurences_topics_1 = occurences |> 
  filter_at(vars(-topic_subcategory), all_vars(. >=20)) |> 
  select(topic_subcategory) |> 
  unlist() |> 
  array()

occurences |> 
  filter_at(vars(-topic_subcategory), all_vars(. >=20)) |> 
  gt() |> 
  data_color(
  columns = vars(ii_round1, ii_round2, matnat_no_ii1, matnat_no_ii2, oth_inst1, oth_inst2),
  colors = scales::col_numeric(
    c("lightgrey", "green"), 
    domain = c(0, 100)))
  
```

```{r}
occurences_topics_2 = occurences |> 
  group_by(topic_subcategory) |> 
  summarise(r1 = sum(ii_round1, matnat_no_ii1, oth_inst1),
            r2 = sum(ii_round2, matnat_no_ii2, oth_inst2)) |> 
  filter_at(vars(-topic_subcategory), all_vars(. >=20)) |> 
  select(topic_subcategory) |> 
  unlist() |> 
  array()

occurences |> 
  group_by(topic_subcategory) |> 
  summarise(r1 = sum(ii_round1, matnat_no_ii1, oth_inst1),
            r2 = sum(ii_round2, matnat_no_ii2, oth_inst2)) |> 
  # filter_at(vars(-topic_subcategory), all_vars(. >=20)) |> 
  gt() |> 
  data_color(
  columns = vars(r1, r2),
  colors = scales::col_numeric(
    c("lightgrey", "green"), 
    domain = c(0, 200)))
```

```{r}
all(sort(occurences_topics_1) == sort(occurences_topics_2))
print(occurences_topics_1)
```
* we possibly cannot perform the analysis over the institutes, (will see about this below)

#### Versioning

The versioning was not counted before `2024-10-11 16:25:40` [commit](https://git.app.uib.no/ii/did/sasha_prestudy/-/commit/a024deedc01d34c2cf22346d3590eee4f05526f4) due to mistake on application's design side. More data to be gathered to find out whether the mistake can cause additional biases in data.

```{r}
df_act |> 
  filter(action == "version") |> 
  arrange(timestamp)
```

### RQ1: Does the context of assessment implies a bias to familiarity / gendering of the topic?

* Seems like context of language studies makes everything bit less gender biased, so we can't combine round1 and round2 data together.

```{r}
total_df |> 
  filter(topic %in% occurences_topics_1 & field %in% c('base', 'lang')) |> 
  group_by(topic, field) |> 
  summarise(
    avg_fam = mean(familiarity),
    avg_gen = mean(gender),
    gen_eff = abs(avg_gen),
    obs = n()
  ) |> 
  filter(obs > 10) |> 
  gt(rowname_col = "field") |> 
  data_color(
    columns = vars(avg_gen),
    colors = scales::col_numeric(
      c("#509DA9", "#ffeb84", "#DD6C40"), 
      domain = c(-2.5, 0, 2)))
```

* No consistent effect was found for economics and computer science context:

```{r}
total_df |> 
  filter(topic %in% occurences_topics_1 & field %in% c('base', 'econ', 'cs')) |> 
  group_by(topic, field) |> 
  summarise(
    avg_fam = mean(familiarity),
    avg_gen = mean(gender),
    gen_eff = abs(avg_gen),
    obs = n()
  ) |> 
  filter(obs > 10) |> 
  gt(rowname_col = "field") |> 
  data_color(
    columns = vars(avg_gen),
    colors = scales::col_numeric(
      c("#509DA9", "#ffeb84", "#DD6C40"), 
      domain = c(-2.5, 0, 2)))
```

## Bugfixing (DONT READ BELOW ITS ALL WRONG)

### What topics are mostly perceived as masculine or feminine?

There's a slight shift in topics set to a be more masculine:

```{r}

```

It also reflects on the most extreme topics: **first 11 masuline topic are more related to the gender than the 2nd femine topic**:

```{r}
# todo: add number of topic occurences in the prestudy
# todo: subsets of ii - scitek - others
# todo: gender split

evals2_avgs = evals2 |> 
  filter(round == 1) |> 
  group_by(topic) |> 
  summarise(
    avg_fam = mean(familiarity),
    avg_gen = mean(gender),
    gen_eff = abs(avg_gen)
  ) 

evals2_avgs |> 
  arrange(-gen_eff) |> 
  head(30) |> 
  select(-gen_eff) |> 
  gt() |> 
  data_color(
    columns = vars(avg_gen),
    colors = scales::col_numeric(
      c("#509DA9", "#ffeb84", "#DD6C40"), 
      domain = c(-2.5, 0, 2))) |>
  cols_label(
    avg_fam = "avg.Familiarity",
    avg_gen = "avg.Gender Score"
  ) |> 
  tab_header(
    title = md("Top 15 topics that are mostly perceived as masculine or feminine"),
    subtitle = "sorted by absolute values"
  )
```

Possible outcomes:

* as the topic list was generated entirely by males, it could be a design bias.  
  * e.g. things that were percieved as masculine are usually more specific (olympic records, star trek) than those that were considered as feminine (hr management, poetry). 
* maybe stimuli in psycology tend to be related with more protected class of students?

### Does the distribution of familiarity scores match gender perception?

There's no correlation or effect of familiarity on gender scores.  

```{r}
ggplot(evals2_avgs) +
  geom_point(aes(x = avg_fam, y = avg_gen, color = avg_gen), size = 4) + 
  geom_hline(yintercept = 0, linetype = "dashed", alpha = 0.5) +
  theme_minimal() +
  labs(
    title = "Does the distribution of familiarity scores match gender perception?",
    x = "Average familiarity",
    y = "Average gender score",
    color = ""
  ) + 
  scale_color_gradient2(
    low = "#509DA9", 
    mid = "#ffeb84", 
    high = "#DD6C40", 
    midpoint = 0
  )
```

```{r}
summary(lm(avg_gen ~ avg_fam, evals2_avgs))
```

* Students seem like hesitate to give extreme values to the topics even if they are familiar with it:

```{r}
evals2 |> 
  filter(round == 1) |> 
  mutate(familiarity = as.factor(familiarity),
         gender = as.factor(gender)) |> 
  group_by(familiarity, gender) |> 
  count() |> 
  ggplot() +
    geom_bar(aes(x = gender, y = n), stat = "identity") +
    facet_grid(rows = vars(familiarity),
               labeller = as_labeller(c(`1` = "Not at All",
                                        `2` = "Slightly ",
                                        `3` = "Moderately ",
                                        `4` = "Very",
                                        `5` = "Highly"))) +
    theme_minimal() +
    labs(
      title = "Does the distribution of familiarity scores match gender perception?",
      x = "Average gender score",
      y = "N responses",
      
    ) + 
    scale_color_gradient2(
      low = "#509DA9", 
      mid = "#ffeb84", 
      high = "#DD6C40", 
      midpoint = 0
    )
```

### Do men and women differ in the extent to which they associate the topics with the certain gender?

```{r}
evals_sex = resp |> 
  mutate(sex = as.factor(gender)) |> 
  mutate(sex = fct_recode(sex, "non binary"="other")) |> 
  select(id, sex) |> 
  right_join(evals, by = "id") 
```

No difference between genders in gender evaluations distribution:

```{r}
evals_sex |> 
  group_by(sex, familiarity, gender) |> 
  count() |> 
  na.omit() |> 
  ggplot() +
  geom_bar(aes(x = gender, y = n, group = sex, fill = sex), stat = "identity", position = position_dodge()) +
  theme_minimal() +
  labs(
    title = "Distribution of Gender Perception Evaluation by Gender",
    # subtitle = "Distribution of Prestudy Respondents",
    x = "Gender Score",
    y = "Respondents"
  ) +
  scale_fill_manual(values=c("#DD6C40", "#509DA9", "#C4E059")) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

No significant difference between genders in familiarity distribution:

```{r}
evals_sex |> 
  group_by(sex, familiarity, gender) |> 
  count() |> 
  na.omit() |> 
  ggplot() +
  geom_bar(aes(x = familiarity, y = n, group = sex, fill = sex), stat = "identity", position = position_dodge()) +
  theme_minimal() +
  labs(
    title = "Distribution of Familiarity Evaluation by Gender",
    # subtitle = "Distribution of Prestudy Respondents",
    x = "Familiarity",
    y = "Respondents"
  ) +
  scale_fill_manual(values=c("#DD6C40", "#509DA9", "#C4E059")) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))
```

```{r}
evals2sex = resp |> 
  mutate(sex = as.factor(gender)) |> 
  mutate(sex = fct_recode(sex, "non binary"="other")) |> 
  select(id, sex) |> 
  right_join(evals2, by = "id")

evals2sex_avg = evals2sex |> 
  filter(round == 1) |> 
  group_by(topic, sex) |> 
  summarise(
    avg_fam = mean(familiarity),
    avg_gen = mean(gender),
    gen_eff = abs(avg_gen)
  ) |> 
  na.omit()

evals2sex_avg

evals2sex_avg |> 
  arrange(-gen_eff) |> 
  head(30) |> 
  select(-gen_eff) |> 
  gt(rowname_col = "sex") |> 
  # tab_row_group(
  #   label = "Gender",
  #   rows = sex) |>
  data_color(
    columns = vars(avg_gen),
    colors = scales::col_numeric(
      c("#509DA9", "#ffeb84", "#DD6C40"), 
      domain = c(-2.5, 0, 2)))



  # cols_label(
  #   avg_fam = "avg.Familiarity",
  #   avg_gen = "avg.Gender Score"
  # ) |> 
  # tab_header(
  #   title = md("Top 15 topics that are mostly perceived as masculine or feminine"),
  #   subtitle = "sorted by absolute values"
  # )
```

### Departments and Institutes

```{r}
evals |> 
  left_join(select(resp, id, subj), by = "id") |> 
  filter(subj == "Department of Informatics") |> 
  group_by(gender_level = as.factor(gender)) |> 
  count() |> 
  ggplot() +
  geom_bar(aes(x = gender_level, y = n), stat = "identity") +
  theme_minimal() +
  labs(title = "Distribution of gender evaluations in the prestudy",
       x = "Level of gender perception",
       y = "Observations") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1))

```

--- end of non valid ---


```{r}


total_df |> 
  group_by(topic, institute, subj) |> 
  count()
```

